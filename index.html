<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LEV — Console Textual</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#0f1624; --panel2:#101b2d;
      --text:#e8eefc; --muted:#a9b6d3; --accent:#7aa2ff;
      --danger:#ff6b7a; --ok:#4ee6a8; --warn:#ffd36b;
      --border:rgba(255,255,255,.08);
      --shadow:0 18px 40px rgba(0,0,0,.45);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1000px 700px at 15% 0%, rgba(122,162,255,.18), transparent 55%),
               radial-gradient(900px 600px at 85% 10%, rgba(78,230,168,.12), transparent 55%),
               var(--bg);
      color:var(--text); font-family:var(--sans);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; background:rgba(15,22,36,.7); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px);
      position:sticky; top:14px; z-index:10;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.85), rgba(78,230,168,.75));
      box-shadow: 0 8px 24px rgba(122,162,255,.18);
    }
    .brand h1{font-size:15px; margin:0; letter-spacing:.3px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .chip{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--border); background:rgba(16,27,45,.7);
      color:var(--muted);
    }
    .chip b{color:var(--text)}
    .chip.ok{border-color:rgba(78,230,168,.35); color:#c8ffe9}
    .chip.warn{border-color:rgba(255,211,107,.35); color:#ffe9b8}
    .chip.bad{border-color:rgba(255,107,122,.35); color:#ffd0d6}
    .grid{
      display:grid; grid-template-columns: 320px 1fr; gap:16px; margin-top:16px;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      background:rgba(15,22,36,.75); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 16px; font-size:13px; letter-spacing:.35px;
      color:#dfe7ff; background: rgba(16,27,45,.6); border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{padding:14px 16px}
    .muted{color:var(--muted); font-size:13px; line-height:1.4}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap}
    button{
      cursor:pointer; border:none; border-radius:12px; padding:10px 12px;
      background:rgba(122,162,255,.14); color:var(--text);
      border:1px solid rgba(122,162,255,.22);
      transition: transform .06s ease, background .15s ease;
      font-size:13px;
    }
    button:hover{background:rgba(122,162,255,.22)}
    button:active{transform: translateY(1px)}
    button.secondary{background:rgba(255,255,255,.06); border-color:var(--border)}
    button.danger{background:rgba(255,107,122,.12); border-color:rgba(255,107,122,.22)}
    button.ok{background:rgba(78,230,168,.12); border-color:rgba(78,230,168,.22)}
    button.warn{background:rgba(255,211,107,.12); border-color:rgba(255,211,107,.22)}
    .nav{
      display:flex; flex-direction:column; gap:8px;
    }
    .nav button{width:100%; text-align:left; display:flex; justify-content:space-between; align-items:center}
    .nav .hint{color:var(--muted); font-size:11px}
    .field{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    label{font-size:12px; color:var(--muted)}
    input, textarea, select{
      width:100%;
      background: rgba(16,27,45,.7);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-family:var(--sans);
      font-size:13px;
    }
    textarea{min-height:180px; resize:vertical; font-family:var(--mono); font-size:12.5px; line-height:1.4}
    .mono{font-family:var(--mono)}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 920px){ .split{grid-template-columns:1fr} }
    .hr{height:1px; background:var(--border); margin:12px 0}
    .kpi{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    @media (max-width: 920px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border:1px solid var(--border); background:rgba(16,27,45,.55);
      padding:10px 12px; border-radius:14px;
    }
    .kpi .box .t{font-size:11px; color:var(--muted)}
    .kpi .box .v{font-size:14px; margin-top:4px}
    .toast{
      position: fixed; right:16px; bottom:16px; max-width:520px;
      background: rgba(15,22,36,.95); border:1px solid var(--border); color:var(--text);
      border-radius: 14px; padding: 12px 14px; box-shadow:var(--shadow);
      display:none;
    }
    .toast .small{color:var(--muted); font-size:12px; margin-top:4px}
    .pill{
      display:inline-block; font-size:11px; padding:5px 8px; border-radius:999px;
      border:1px solid var(--border); background:rgba(255,255,255,.05); color:var(--muted);
    }
    .dangerText{color:#ffd0d6}
    .okText{color:#c8ffe9}
    .warnText{color:#ffe9b8}
    .copybar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>LEV — Console Textual <span class="pill" id="pbVer">PB v1.7</span></h1>
        <div class="sub">Site texto (MVP local). Login/DB/assinaturas reais exigem servidor.</div>
      </div>
    </div>
    <div class="chips">
      <div class="chip" id="chipUser">Usuário: <b>—</b></div>
      <div class="chip" id="chipRole">Role: <b>—</b></div>
      <div class="chip" id="chipGate">Gate: <b>—</b></div>
      <div class="chip" id="chipLic">Licença: <b>—</b></div>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT NAV -->
    <div class="card">
      <h2>Menu <span class="hint mono" id="modeHint">modo: —</span></h2>
      <div class="body">
        <div class="nav" id="nav"></div>
        <div class="hr"></div>
        <div class="muted">
          <b>Notas</b><br/>
          • Este MVP salva em <span class="mono">localStorage</span>.<br/>
          • “Senha” aqui é só demo local (não use em produção).<br/>
          • Para produção: backend valida login/licença/sig/nonce.
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="card">
      <h2>
        <span id="viewTitle">Login</span>
        <span class="copybar">
          <button class="secondary" id="btnExportAll" title="Exporta PB + bandejas + dados">Exportar Tudo</button>
          <button class="secondary" id="btnReset" title="Apaga dados locais">Reset Local</button>
        </span>
      </h2>
      <div class="body" id="view"></div>
    </div>

  </div>
</div>

<div class="toast" id="toast">
  <div id="toastMsg"></div>
  <div class="small" id="toastSub"></div>
</div>

<script>
/**
 * LEV Site MVP (local)
 * - Armazena dados do usuário em localStorage
 * - Simula licença 30 dias
 * - Suporta sync Copia-e-Cola (LEV_DOWNLOAD / LEV_UPLOAD)
 * - Suporta bandejas (EXIT_TRAY / ADMIN_EXIT_TRAY)
 *
 * IMPORTANTE: Para produção, mover auth/licença/sig/nonce para backend.
 */

const PB_VERSION = "1.7";
const STORE_KEY = "LEV_SITE_MVP_V1";
const nowISO = () => new Date().toISOString();
const addDays = (d, days) => new Date(d.getTime() + days*24*60*60*1000);

function toast(msg, sub=""){
  const t = document.getElementById("toast");
  document.getElementById("toastMsg").textContent = msg;
  document.getElementById("toastSub").textContent = sub;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> t.style.display="none", 3300);
}

function load(){
  const raw = localStorage.getItem(STORE_KEY);
  if(!raw){
    const seed = {
      pb_version: PB_VERSION,
      access_gate: { active:false, activation_id:"", issued_at:"", activated_by:"", sig:"" },
      session: { logged_in:false, user_id:"", role:"", username:"" },
      users: {
        // demo: senha em texto puro é INSEGURO. Aqui é somente MVP local.
        // produção: use hash no backend.
        "LEV-ADM-0001": {
          user_id:"LEV-ADM-0001",
          username:"admin",
          password:"lev2026", // DEMO
          role:"ADM",
          created_at: nowISO(),
          license: { status:"ACTIVE", expires_at: addDays(new Date(), 30).toISOString() },
          preferences: { idioma:"pt", formato_resposta:"estruturado", nivel_detalhe:"alto", modo_perguntas:"local" },
          perfil_operacional: { style:"medio", format:"checklist", ask_bias:"medio", cadence:"normal", risk_posture:"padrao" },
          context_tray: { mode:"OFF", retention_days:0, updated_at: nowISO(), content:"" },
          user_space: { listas:"", afazeres:"", projetos:"LEV\n", compras:"", financeiro:"", planilhas:"", anotacoes:"" },
          trays: { exit_tray:"", admin_exit_tray:"" }
        }
      },
      logs: []
    };
    localStorage.setItem(STORE_KEY, JSON.stringify(seed));
    return seed;
  }
  return JSON.parse(raw);
}
function save(state){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

let state = load();

function logEvt(type, details={}){
  state.logs.unshift({ at: nowISO(), type, details });
  if(state.logs.length > 300) state.logs.pop();
  save(state);
}

function licenseInfo(u){
  const exp = new Date(u.license.expires_at);
  const diff = exp.getTime() - Date.now();
  const days = Math.ceil(diff / (24*60*60*1000));
  const status = diff <= 0 ? "EXPIRED" : u.license.status;
  return { status, expires_at:u.license.expires_at, expires_in_days: Math.max(days,0) };
}

function gateActive(){
  return !!(state.access_gate && state.access_gate.active);
}

function currentUser(){
  if(!state.session.logged_in) return null;
  return state.users[state.session.user_id] || null;
}

function isReadOnly(u){
  // READ_ONLY se gate ausente OU licença expirada
  const li = licenseInfo(u);
  if(!gateActive()) return true;
  if(li.status !== "ACTIVE") return true;
  return false;
}

function setChips(){
  const u = currentUser();
  const chipUser = document.getElementById("chipUser");
  const chipRole = document.getElementById("chipRole");
  const chipGate = document.getElementById("chipGate");
  const chipLic  = document.getElementById("chipLic");

  document.getElementById("pbVer").textContent = "PB v"+PB_VERSION;

  if(!u){
    chipUser.innerHTML = 'Usuário: <b>—</b>';
    chipRole.innerHTML = 'Role: <b>—</b>';
    chipGate.innerHTML = 'Gate: <b>—</b>';
    chipLic.innerHTML  = 'Licença: <b>—</b>';
    chipUser.className = "chip";
    chipRole.className = "chip";
    chipGate.className = "chip";
    chipLic.className  = "chip";
    document.getElementById("modeHint").textContent = "modo: —";
    return;
  }

  const li = licenseInfo(u);
  const ro = isReadOnly(u);

  chipUser.innerHTML = `Usuário: <b>${u.user_id}</b>`;
  chipRole.innerHTML = `Role: <b>${u.role}</b>`;
  chipGate.innerHTML = `Gate: <b>${gateActive() ? "ATIVO" : "AUSENTE"}</b>`;
  chipLic.innerHTML  = `Licença: <b>${li.status}</b> (${li.expires_in_days}d)`;

  chipGate.className = "chip " + (gateActive() ? "ok" : "warn");
  chipLic.className  = "chip " + (li.status==="ACTIVE" ? "ok" : "bad");
  chipRole.className = "chip " + (u.role==="ADM" ? "warn" : "");
  document.getElementById("modeHint").textContent = "modo: " + (u.role==="ADM" ? "ADM" : "USUÁRIO") + (ro ? " (READ_ONLY)" : "");
}

function navItems(){
  const u = currentUser();
  if(!u){
    return [
      { id:"login", label:"Login", hint:"entrar" },
      { id:"about", label:"Sobre", hint:"PB/limites" },
    ];
  }
  const ro = isReadOnly(u);
  const base = [
    { id:"home", label:"Painel", hint:"status" },
    { id:"user_space", label:"User Space", hint:"texto" },
    { id:"prefs", label:"Preferências", hint:"formato" },
    { id:"context", label:"Contexto", hint:"opt-in" },
    { id:"trays", label:"Bandejas", hint:"exit/admin" },
    { id:"sync", label:"Sync Copia-e-Cola", hint:"upload/download" },
    { id:"commands", label:"Comandos ADM", hint:"lista" },
    { id:"logs", label:"Logs", hint:"audit" },
  ];
  if(u.role==="ADM") base.unshift({ id:"admin", label:"Admin", hint: ro ? "read-only" : "controle" });
  base.push({ id:"logout", label:"Sair", hint:"logout" });
  return base;
}

function renderNav(activeId){
  const nav = document.getElementById("nav");
  nav.innerHTML = "";
  navItems().forEach(it=>{
    const b = document.createElement("button");
    b.className = (it.id===activeId) ? "ok" : "secondary";
    b.innerHTML = `<span>${it.label}</span><span class="hint mono">${it.hint||""}</span>`;
    b.onclick = ()=> route(it.id);
    nav.appendChild(b);
  });
}

function viewTitle(t){ document.getElementById("viewTitle").textContent = t; }

function route(id){
  setChips();
  renderNav(id);

  const u = currentUser();
  const v = document.getElementById("view");

  // logout pseudo-route
  if(id==="logout"){
    state.session = { logged_in:false, user_id:"", role:"", username:"" };
    save(state); logEvt("logout");
    toast("Sessão encerrada.");
    return route("login");
  }

  if(id==="login"){
    viewTitle("Login");
    v.innerHTML = `
      <div class="muted">Entre com um usuário local (MVP). Em produção, isso vem do seu servidor.</div>
      <div class="hr"></div>
      <div class="field">
        <label>User ID</label>
        <input id="inUser" placeholder="ex: LEV-ADM-0001" />
      </div>
      <div class="field">
        <label>Senha (demo local)</label>
        <input id="inPass" type="password" placeholder="ex: lev2026" />
      </div>
      <div class="btnrow">
        <button class="ok" id="btnLogin">Entrar</button>
        <button class="secondary" id="btnCreateUser">Criar USER demo</button>
      </div>
      <div class="hr"></div>
      <div class="muted">
        <b>Demo pronta:</b><br/>
        • <span class="mono">LEV-ADM-0001</span> / <span class="mono">lev2026</span> (ADM)<br/>
        <span class="dangerText">Não use isso em produção.</span>
      </div>
    `;
    document.getElementById("btnLogin").onclick = ()=>{
      const uid = (document.getElementById("inUser").value||"").trim();
      const pw  = (document.getElementById("inPass").value||"").trim();
      const usr = state.users[uid];
      if(!usr || usr.password !== pw){
        toast("Login inválido.", "Verifique user_id e senha (demo).");
        logEvt("login_fail", { uid });
        return;
      }
      state.session = { logged_in:true, user_id:usr.user_id, role:usr.role, username:usr.username||"" };
      save(state); logEvt("login_ok", { uid, role:usr.role });
      toast("Login OK.", `Bem-vindo: ${usr.user_id} (${usr.role})`);
      route("home");
    };
    document.getElementById("btnCreateUser").onclick = ()=>{
      const newId = "LEV-U-" + Math.random().toString(36).slice(2,7).toUpperCase();
      state.users[newId] = {
        user_id:newId, username:"user", password:"1234", role:"USER", created_at:nowISO(),
        license:{ status:"ACTIVE", expires_at:addDays(new Date(),30).toISOString() },
        preferences:{ idioma:"pt", formato_resposta:"estruturado", nivel_detalhe:"medio", modo_perguntas:"local" },
        perfil_operacional:{ style:"medio", format:"checklist", ask_bias:"medio", cadence:"normal", risk_posture:"padrao" },
        context_tray:{ mode:"OFF", retention_days:0, updated_at:nowISO(), content:"" },
        user_space:{ listas:"", afazeres:"", projetos:"", compras:"", financeiro:"", planilhas:"", anotacoes:"" },
        trays:{ exit_tray:"", admin_exit_tray:"" }
      };
      save(state); logEvt("user_created_demo", { user_id:newId });
      toast("USER demo criado.", `ID: ${newId} / senha: 1234`);
      document.getElementById("inUser").value = newId;
      document.getElementById("inPass").value = "1234";
    };
    return;
  }

  if(id==="about"){
    viewTitle("Sobre");
    v.innerHTML = `
      <div class="muted">
        <b>O que este site é:</b> um console textual do LEV (MVP local), pronto para você codificar depois.<br/><br/>
        <b>O que ele não é:</b> servidor real de autenticação/licença/assinaturas. Em produção isso fica no backend.<br/><br/>
        <b>PB_ACCESS_GATE:</b> aqui ele bloqueia escrita quando ausente (modo READ_ONLY). Ative em Admin → Gate.
      </div>
    `;
    return;
  }

  // Require login after this point
  if(!u) return route("login");

  // Views
  if(id==="home"){
    viewTitle("Painel");
    const li = licenseInfo(u);
    const ro = isReadOnly(u);
    v.innerHTML = `
      <div class="kpi">
        <div class="box"><div class="t">PB</div><div class="v mono">v${PB_VERSION}</div></div>
        <div class="box"><div class="t">Gate</div><div class="v ${gateActive()?'okText':'warnText'}">${gateActive()?'ATIVO':'AUSENTE (READ_ONLY)'}</div></div>
        <div class="box"><div class="t">Licença</div><div class="v ${li.status==='ACTIVE'?'okText':'dangerText'}">${li.status} — ${li.expires_in_days} dias</div></div>
      </div>
      <div class="hr"></div>
      <div class="muted">
        <b>Estado</b><br/>
        • Usuário: <span class="mono">${u.user_id}</span><br/>
        • Role: <span class="mono">${u.role}</span><br/>
        • Modo: <span class="mono">${u.role==="ADM"?"ADM":"USUÁRIO"}</span>${ro ? ' <span class="warnText">(READ_ONLY)</span>' : ''}<br/>
      </div>
      <div class="hr"></div>
      <div class="btnrow">
        <button class="secondary" onclick="route('sync')">Sync Copia-e-Cola</button>
        <button class="secondary" onclick="route('trays')">Bandejas</button>
        <button class="secondary" onclick="route('user_space')">User Space</button>
      </div>
    `;
    return;
  }

  if(id==="admin"){
    viewTitle("Admin");
    const li = licenseInfo(u);
    const ro = isReadOnly(u);
    v.innerHTML = `
      <div class="muted">
        <b>Admin Console</b><br/>
        • Este painel controla <span class="mono">PB_ACCESS_GATE</span> (demo) e a licença (demo).<br/>
        • Em produção, tudo isso fica no backend.
      </div>
      <div class="hr"></div>

      <div class="split">
        <div>
          <h3 style="margin:0 0 8px 0; font-size:13px;">PB_ACCESS_GATE</h3>
          <div class="muted">Sem Gate → READ_ONLY (bloqueia escrita/exportação).</div>
          <div class="field">
            <label>Activated By</label>
            <select id="gateBy">
              <option>SITE</option><option>APP</option><option>CLI</option>
            </select>
          </div>
          <div class="btnrow">
            <button class="ok" id="btnGateOn">Ativar Gate (demo)</button>
            <button class="danger" id="btnGateOff">Remover Gate</button>
          </div>
          <div class="hr"></div>
          <div class="field">
            <label>Bloco atual</label>
            <textarea id="gateBlock" readonly></textarea>
          </div>
          <div class="btnrow">
            <button class="secondary" id="btnCopyGate">Copiar bloco</button>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0; font-size:13px;">Licença (demo local)</h3>
          <div class="muted">Status: <b class="${li.status==='ACTIVE'?'okText':'dangerText'}">${li.status}</b> — expira em <span class="mono">${li.expires_at}</span></div>
          <div class="btnrow" style="margin-top:10px">
            <button class="ok" id="btnRenew">Renovar +30 dias</button>
            <button class="danger" id="btnExpire">Expirar agora</button>
          </div>
          <div class="hr"></div>

          <h3 style="margin:0 0 8px 0; font-size:13px;">Read-only</h3>
          <div class="muted">Read-only é automático se Gate ausente OU Licença expirada.</div>
          <div class="muted">Estado atual: ${ro ? '<b class="warnText">READ_ONLY</b>' : '<b class="okText">FULL</b>'}</div>

          <div class="hr"></div>
          <h3 style="margin:0 0 8px 0; font-size:13px;">Comandos (referência)</h3>
          <div class="muted mono">
            UPDATE<br/>
            ATUALIZAR LEV MAXIMO BUDGET_MIN=60 RISCO_MAX=MEDIO<br/>
            LEV_SECURITY_APPLY MODE=manual RISK=low<br/>
            LEV_SECURITY_VERIFY CHECKS=root,health,api_ping RISK=low
          </div>
        </div>
      </div>
    `;

    const blockEl = document.getElementById("gateBlock");
    function renderGateBlock(){
      if(!state.access_gate.active){
        blockEl.value = "(Gate ausente)";
        return;
      }
      blockEl.value =
`===LEV_PB_ACCESS_BEGIN===
activated_by: ${state.access_gate.activated_by}
activation_id: ${state.access_gate.activation_id}
issued_at: ${state.access_gate.issued_at}
sig: ${state.access_gate.sig}
===LEV_PB_ACCESS_END===`;
    }
    renderGateBlock();

    document.getElementById("btnGateOn").onclick = ()=>{
      state.access_gate.active = true;
      state.access_gate.activated_by = document.getElementById("gateBy").value;
      state.access_gate.activation_id = "ACT-" + Math.random().toString(36).slice(2,10).toUpperCase();
      state.access_gate.issued_at = nowISO();
      state.access_gate.sig = "SIG_DEMO_" + Math.random().toString(36).slice(2,8).toUpperCase();
      save(state); logEvt("gate_on", { activation_id: state.access_gate.activation_id });
      renderGateBlock(); setChips();
      toast("Gate ativado (demo).", "Agora FULL MODE depende da licença.");
      route("admin");
    };
    document.getElementById("btnGateOff").onclick = ()=>{
      state.access_gate = { active:false, activation_id:"", issued_at:"", activated_by:"", sig:"" };
      save(state); logEvt("gate_off");
      renderGateBlock(); setChips();
      toast("Gate removido.", "READ_ONLY ativo.");
      route("admin");
    };
    document.getElementById("btnCopyGate").onclick = async ()=>{
      await navigator.clipboard.writeText(blockEl.value);
      toast("Bloco copiado.");
    };

    document.getElementById("btnRenew").onclick = ()=>{
      const exp = new Date(u.license.expires_at);
      const base = exp.getTime() < Date.now() ? new Date() : exp;
      u.license.status = "ACTIVE";
      u.license.expires_at = addDays(base, 30).toISOString();
      state.users[u.user_id] = u;
      save(state); logEvt("license_renew", { user_id:u.user_id });
      toast("Licença renovada +30 dias.");
      route("admin");
    };
    document.getElementById("btnExpire").onclick = ()=>{
      u.license.status = "EXPIRED";
      u.license.expires_at = new Date(Date.now()-1000).toISOString();
      state.users[u.user_id] = u;
      save(state); logEvt("license_expire", { user_id:u.user_id });
      toast("Licença expirada.", "READ_ONLY ativo.");
      route("admin");
    };
    return;
  }

  if(id==="user_space"){
    viewTitle("User Space");
    const ro = isReadOnly(u);
    const categories = ["listas","afazeres","projetos","compras","financeiro","planilhas","anotacoes"];
    v.innerHTML = `
      <div class="muted">
        Tudo aqui é <b>texto claro</b>. ${ro ? '<span class="warnText">READ_ONLY: escrita bloqueada.</span>' : 'Você pode editar e salvar.'}
      </div>
      <div class="hr"></div>
      <div class="field">
        <label>Categoria</label>
        <select id="usCat">${categories.map(c=>`<option value="${c}">${c}</option>`).join("")}</select>
      </div>
      <div class="field">
        <label>Conteúdo</label>
        <textarea id="usText" ${ro?'readonly':''}></textarea>
      </div>
      <div class="btnrow">
        <button class="ok" id="btnSaveUS" ${ro?'disabled':''}>Salvar</button>
        <button class="secondary" id="btnCopyUS">Copiar bloco LEV_USER_DATA</button>
      </div>
    `;
    const cat = document.getElementById("usCat");
    const txt = document.getElementById("usText");
    function loadCat(){
      txt.value = (u.user_space[cat.value] || "");
    }
    cat.onchange = loadCat;
    loadCat();

    document.getElementById("btnSaveUS").onclick = ()=>{
      u.user_space[cat.value] = txt.value;
      state.users[u.user_id] = u;
      save(state); logEvt("user_space_save", { user_id:u.user_id, cat:cat.value });
      toast("User Space salvo.", cat.value);
    };
    document.getElementById("btnCopyUS").onclick = async ()=>{
      const block =
`===LEV_USER_DATA_BEGIN===
user_id: ${u.user_id}
category: ${cat.value}
title:
updated_at: ${nowISO()}

${txt.value}
===LEV_USER_DATA_END===`;
      await navigator.clipboard.writeText(block);
      toast("Bloco LEV_USER_DATA copiado.");
    };
    return;
  }

  if(id==="prefs"){
    viewTitle("Preferências");
    const ro = isReadOnly(u);
    v.innerHTML = `
      <div class="split">
        <div>
          <div class="muted">${ro ? '<span class="warnText">READ_ONLY: escrita bloqueada.</span>' : 'Edite e salve preferências/perfil operacional.'}</div>
          <div class="hr"></div>

          <h3 style="margin:0 0 8px 0; font-size:13px;">Preferências</h3>
          <div class="field"><label>Idioma</label><input id="pLang" value="${u.preferences.idioma||'pt'}" ${ro?'readonly':''}/></div>
          <div class="field"><label>Formato</label><input id="pFmt" value="${u.preferences.formato_resposta||'estruturado'}" ${ro?'readonly':''}/></div>
          <div class="field"><label>Nível detalhe</label><input id="pDet" value="${u.preferences.nivel_detalhe||'medio'}" ${ro?'readonly':''}/></div>
          <div class="field"><label>Modo perguntas</label><input id="pQ" value="${u.preferences.modo_perguntas||'local'}" ${ro?'readonly':''}/></div>

          <div class="btnrow">
            <button class="ok" id="btnSavePrefs" ${ro?'disabled':''}>Salvar</button>
            <button class="secondary" id="btnCopyPrefs">Copiar (texto)</button>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0; font-size:13px;">Perfil Operacional (opt-in)</h3>
          <div class="field"><label>Style</label><input id="oStyle" value="${u.perfil_operacional.style||'medio'}" ${ro?'readonly':''}/></div>
          <div class="field"><label>Format</label><input id="oFmt" value="${u.perfil_operacional.format||'checklist'}" ${ro?'readonly':''}/></div>
          <div class="field"><label>Ask bias</label><input id="oAsk" value="${u.perfil_operacional.ask_bias||'medio'}" ${ro?'readonly':''}/></div>
          <div class="field"><label>Cadence</label><input id="oCad" value="${u.perfil_operacional.cadence||'normal'}" ${ro?'readonly':''}/></div>
          <div class="field"><label>Risk posture</label><input id="oRisk" value="${u.perfil_operacional.risk_posture||'padrao'}" ${ro?'readonly':''}/></div>

          <div class="btnrow">
            <button class="ok" id="btnSaveOps" ${ro?'disabled':''}>Salvar</button>
            <button class="secondary" id="btnCopyOps">Copiar (texto)</button>
          </div>
        </div>
      </div>
    `;

    document.getElementById("btnSavePrefs").onclick = ()=>{
      u.preferences = {
        idioma: document.getElementById("pLang").value.trim(),
        formato_resposta: document.getElementById("pFmt").value.trim(),
        nivel_detalhe: document.getElementById("pDet").value.trim(),
        modo_perguntas: document.getElementById("pQ").value.trim(),
      };
      state.users[u.user_id]=u; save(state); logEvt("prefs_save",{user_id:u.user_id});
      toast("Preferências salvas.");
    };
    document.getElementById("btnSaveOps").onclick = ()=>{
      u.perfil_operacional = {
        style: document.getElementById("oStyle").value.trim(),
        format: document.getElementById("oFmt").value.trim(),
        ask_bias: document.getElementById("oAsk").value.trim(),
        cadence: document.getElementById("oCad").value.trim(),
        risk_posture: document.getElementById("oRisk").value.trim(),
      };
      state.users[u.user_id]=u; save(state); logEvt("ops_save",{user_id:u.user_id});
      toast("Perfil operacional salvo.");
    };

    document.getElementById("btnCopyPrefs").onclick = async ()=>{
      const txt =
`idioma=${u.preferences.idioma}
formato_resposta=${u.preferences.formato_resposta}
nivel_detalhe=${u.preferences.nivel_detalhe}
modo_perguntas=${u.preferences.modo_perguntas}`;
      await navigator.clipboard.writeText(txt);
      toast("Preferências copiadas.");
    };
    document.getElementById("btnCopyOps").onclick = async ()=>{
      const txt =
`style=${u.perfil_operacional.style}
format=${u.perfil_operacional.format}
ask_bias=${u.perfil_operacional.ask_bias}
cadence=${u.perfil_operacional.cadence}
risk_posture=${u.perfil_operacional.risk_posture}`;
      await navigator.clipboard.writeText(txt);
      toast("Perfil operacional copiado.");
    };
    return;
  }

  if(id==="context"){
    viewTitle("Contexto");
    const ro = isReadOnly(u);
    v.innerHTML = `
      <div class="muted">
        <b>CONTEXT_TRAY</b> é opt-in. ${ro ? '<span class="warnText">READ_ONLY: escrita bloqueada.</span>' : 'Você pode ativar e salvar.'}
      </div>
      <div class="hr"></div>
      <div class="field">
        <label>Modo</label>
        <select id="ctxMode" ${ro?'disabled':''}>
          ${["OFF","MANUAL","AUTO_RESUMO","FULL"].map(m=>`<option ${u.context_tray.mode===m?'selected':''}>${m}</option>`).join("")}
        </select>
      </div>
      <div class="field">
        <label>Retenção (dias)</label>
        <input id="ctxRet" type="number" min="0" value="${u.context_tray.retention_days||0}" ${ro?'readonly':''}/>
      </div>
      <div class="field">
        <label>Conteúdo (texto/resumo)</label>
        <textarea id="ctxTxt" ${ro?'readonly':''}>${u.context_tray.content||""}</textarea>
      </div>
      <div class="btnrow">
        <button class="ok" id="btnCtxSave" ${ro?'disabled':''}>Salvar</button>
        <button class="danger" id="btnCtxClear" ${ro?'disabled':''}>Limpar</button>
        <button class="secondary" id="btnCtxCopy">Copiar bloco CONTEXT_TRAY</button>
      </div>
    `;
    document.getElementById("btnCtxSave").onclick = ()=>{
      u.context_tray.mode = document.getElementById("ctxMode").value;
      u.context_tray.retention_days = parseInt(document.getElementById("ctxRet").value||"0",10);
      u.context_tray.content = document.getElementById("ctxTxt").value;
      u.context_tray.updated_at = nowISO();
      state.users[u.user_id]=u; save(state); logEvt("context_save",{user_id:u.user_id,mode:u.context_tray.mode});
      toast("Contexto salvo.", u.context_tray.mode);
    };
    document.getElementById("btnCtxClear").onclick = ()=>{
      u.context_tray.content = "";
      u.context_tray.updated_at = nowISO();
      state.users[u.user_id]=u; save(state); logEvt("context_clear",{user_id:u.user_id});
      toast("Contexto limpo.");
      route("context");
    };
    document.getElementById("btnCtxCopy").onclick = async ()=>{
      const block =
`===LEV_CONTEXT_TRAY_BEGIN===
user_id: ${u.user_id}
mode: ${u.context_tray.mode}
updated_at: ${u.context_tray.updated_at || nowISO()}
retention_days: ${u.context_tray.retention_days || 0}

content:
${u.context_tray.content || ""}
===LEV_CONTEXT_TRAY_END===`;
      await navigator.clipboard.writeText(block);
      toast("Bloco CONTEXT_TRAY copiado.");
    };
    return;
  }

  if(id==="trays"){
    viewTitle("Bandejas");
    const ro = isReadOnly(u);
    v.innerHTML = `
      <div class="muted">
        Gere bandejas para exportação/auditoria. ${ro ? '<span class="warnText">READ_ONLY: exportação bloqueada.</span>' : ''}
      </div>
      <div class="hr"></div>
      <div class="btnrow">
        <button class="ok" id="btnExit">GERAR BANDEJA_SAIDA</button>
        ${u.role==="ADM" ? `<button class="warn" id="btnAdminExit">GERAR ADMIN_EXIT_TRAY</button>` : ``}
        <button class="secondary" id="btnCopyExit">Copiar EXIT_TRAY</button>
        ${u.role==="ADM" ? `<button class="secondary" id="btnCopyAdminExit">Copiar ADMIN_EXIT_TRAY</button>` : ``}
      </div>
      <div class="hr"></div>
      <div class="split">
        <div>
          <label class="muted">EXIT_TRAY</label>
          <textarea id="outExit" readonly></textarea>
        </div>
        <div>
          <label class="muted">ADMIN_EXIT_TRAY</label>
          <textarea id="outAdminExit" readonly></textarea>
        </div>
      </div>
    `;

    const outExit = document.getElementById("outExit");
    const outAdminExit = document.getElementById("outAdminExit");

    outExit.value = u.trays.exit_tray || "";
    if(outAdminExit) outAdminExit.value = u.trays.admin_exit_tray || "";

    document.getElementById("btnExit").onclick = ()=>{
      if(isReadOnly(u)){
        toast("READ_ONLY: não pode gerar bandeja de saída.", "Ative Gate e tenha licença ACTIVE.");
        return;
      }
      const li = licenseInfo(u);
      const tray =
`===LEV_EXIT_TRAY_BEGIN===
user_id: ${u.user_id}
generated_at: ${nowISO()}
source: site_session
role: ${u.role}
pb_version: ${PB_VERSION}

scope:
- preferencias
- perfil_operacional
- user_space
- contexto_resumido
- decisoes

preferencias:
- idioma: ${u.preferences.idioma}
- formato_resposta: ${u.preferences.formato_resposta}
- nivel_detalhe: ${u.preferences.nivel_detalhe}
- modo_perguntas: ${u.preferences.modo_perguntas}

perfil_operacional:
- style: ${u.perfil_operacional.style}
- format: ${u.perfil_operacional.format}
- ask_bias: ${u.perfil_operacional.ask_bias}
- cadence: ${u.perfil_operacional.cadence}
- risk_posture: ${u.perfil_operacional.risk_posture}

user_space_resumo:
- listas: ${u.user_space.listas ? "preenchido" : "vazio"}
- afazeres: ${u.user_space.afazeres ? "preenchido" : "vazio"}
- projetos: ${u.user_space.projetos ? "preenchido" : "vazio"}
- compras: ${u.user_space.compras ? "preenchido" : "vazio"}
- financeiro: ${u.user_space.financeiro ? "preenchido" : "vazio"}
- planilhas: ${u.user_space.planilhas ? "preenchido" : "vazio"}
- anotacoes: ${u.user_space.anotacoes ? "preenchido" : "vazio"}

contexto_resumido:
- mode: ${u.context_tray.mode}
- objetivo_principal: uso do LEV com governanca e copia-e-cola
- estado_atual: site MVP local, pronto para backend
- licenca: ${li.status} (${li.expires_in_days}d)

decisoes_confirmadas:
- site e autoridade de identidade/licenca/persistencia (producao)
- chat e ambiente de simulacao (quando usado)
- sem auto-aplicacao
- patches review_only

restricoes_reafirmadas:
- sem inferencia sensivel
- sem diagnostico
- sem aprendizagem individual
- sem persistencia oculta

observacoes_finais:
- sessao pode ser encerrada com seguranca
===LEV_EXIT_TRAY_END===`;
      u.trays.exit_tray = tray;
      state.users[u.user_id]=u; save(state); logEvt("exit_tray_gen",{user_id:u.user_id});
      outExit.value = tray;
      toast("BANDEJA_SAIDA gerada.");
    };

    if(u.role==="ADM"){
      document.getElementById("btnAdminExit").onclick = ()=>{
        if(isReadOnly(u)){
          toast("READ_ONLY: não pode gerar bandeja ADM.", "Ative Gate e tenha licença ACTIVE.");
          return;
        }
        const tray =
`===LEV_ADMIN_EXIT_TRAY_BEGIN===
admin_id: ${u.user_id}
generated_at: ${nowISO()}
source: site_session
role: ADM
pb_version: ${PB_VERSION}

decisoes_estruturais:
- PB como fonte unica da verdade
- separacao Prompt / IA / Sistema
- edicao via patch
- sem auto-aplicacao

governanca_reafirmada:
- ADM via role externo
- login/licenca fora do PB
- site como autoridade (producao)

seguranca_reafirmada:
- sem credenciais no PB
- sem tokens embutidos
- API protegida no backend (producao)

mecanismos_de_integridade:
- PB_ACCESS_GATE
- BOOT_TRAY
- UPDATE_TRAY
- EXIT_TRAY
- ADMIN_EXIT_TRAY

status_final:
- pronto_para_deploy: SIM
- pendencias: nenhuma
===LEV_ADMIN_EXIT_TRAY_END===`;
        u.trays.admin_exit_tray = tray;
        state.users[u.user_id]=u; save(state); logEvt("admin_exit_tray_gen",{user_id:u.user_id});
        outAdminExit.value = tray;
        toast("ADMIN_EXIT_TRAY gerada.");
      };
    }

    document.getElementById("btnCopyExit").onclick = async ()=>{
      await navigator.clipboard.writeText(outExit.value || "");
      toast("EXIT_TRAY copiada.");
    };
    if(u.role==="ADM"){
      document.getElementById("btnCopyAdminExit").onclick = async ()=>{
        await navigator.clipboard.writeText(outAdminExit.value || "");
        toast("ADMIN_EXIT_TRAY copiada.");
      };
    }
    return;
  }

  if(id==="sync"){
    viewTitle("Sync Copia-e-Cola");
    const ro = isReadOnly(u);
    const li = licenseInfo(u);

    const download = () => {
      const bundleId = "BND-" + nowISO().slice(0,10).replaceAll("-","") + "-" + Math.random().toString(36).slice(2,6).toUpperCase();
      const issued = new Date();
      const exp = addDays(issued, 30);
      // sig/nonce aqui é DEMO
      return `===LEV_DOWNLOAD_BEGIN===
user_id: ${u.user_id}
bundle_id: ${bundleId}
issued_at: ${issued.toISOString()}
expires_at: ${exp.toISOString()}
license_status: ${li.status}
expires_in_days: ${li.expires_in_days}
pb_version: ${PB_VERSION}

preferences:
idioma=${u.preferences.idioma}
formato_resposta=${u.preferences.formato_resposta}
nivel_detalhe=${u.preferences.nivel_detalhe}
modo_perguntas=${u.preferences.modo_perguntas}

perfil_operacional:
style=${u.perfil_operacional.style}
format=${u.perfil_operacional.format}
ask_bias=${u.perfil_operacional.ask_bias}
cadence=${u.perfil_operacional.cadence}
risk_posture=${u.perfil_operacional.risk_posture}

user_space:
[listas]
${u.user_space.listas || ""}

[afazeres]
${u.user_space.afazeres || ""}

[projetos]
${u.user_space.projetos || ""}

[compras]
${u.user_space.compras || ""}

[financeiro]
${u.user_space.financeiro || ""}

[planilhas]
${u.user_space.planilhas || ""}

[anotacoes]
${u.user_space.anotacoes || ""}

context_tray:
mode=${u.context_tray.mode}
content=${(u.context_tray.content||"").replaceAll("\n","\\n")}

sig: SIG_DEMO_${Math.random().toString(36).slice(2,10).toUpperCase()}
===LEV_DOWNLOAD_END===`;
    };

    v.innerHTML = `
      <div class="muted">
        <b>Download</b> (site → copiar) e <b>Upload</b> (colar → site).<br/>
        ${ro ? '<span class="warnText">READ_ONLY: download/exportação bloqueada.</span>' : 'Use para sincronizar dados em texto.'}
      </div>
      <div class="hr"></div>

      <div class="split">
        <div>
          <h3 style="margin:0 0 8px 0; font-size:13px;">GERAR LEV_DOWNLOAD</h3>
          <div class="btnrow">
            <button class="ok" id="btnGenDL" ${ro?'disabled':''}>GERAR LEV_DOWNLOAD PARA SITE</button>
            <button class="secondary" id="btnCopyDL">Copiar</button>
          </div>
          <div class="field">
            <label>LEV_DOWNLOAD</label>
            <textarea id="dlBox" readonly></textarea>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px 0; font-size:13px;">COLAR LEV_UPLOAD</h3>
          <div class="muted">Cole um bloco <span class="mono">LEV_UPLOAD</span> aqui para importar dados (demo).</div>
          <div class="field">
            <label>LEV_UPLOAD</label>
            <textarea id="upBox" placeholder="Cole aqui..."></textarea>
          </div>
          <div class="btnrow">
            <button class="warn" id="btnApplyUp">Aplicar Upload</button>
            <button class="secondary" id="btnClearUp">Limpar</button>
          </div>
        </div>
      </div>
    `;

    const dlBox = document.getElementById("dlBox");
    const upBox = document.getElementById("upBox");
    document.getElementById("btnGenDL").onclick = ()=>{
      dlBox.value = download();
      logEvt("download_gen",{user_id:u.user_id});
      toast("LEV_DOWNLOAD gerado.");
    };
    document.getElementById("btnCopyDL").onclick = async ()=>{
      await navigator.clipboard.writeText(dlBox.value || "");
      toast("LEV_DOWNLOAD copiado.");
    };

    document.getElementById("btnClearUp").onclick = ()=> upBox.value = "";

    document.getElementById("btnApplyUp").onclick = ()=>{
      // Demo parser: procura blocos simples "payload_type" e "payload"
      const raw = upBox.value || "";
      if(!raw.includes("===LEV_UPLOAD_BEGIN===") || !raw.includes("===LEV_UPLOAD_END===")){
        toast("Upload inválido.", "Bloco LEV_UPLOAD não detectado.");
        return;
      }
      // Apenas demo: não valida sig/nonce.
      // Produção: validar user_id da sessão + nonce + sig + expiração.
      const get = (k)=>{
        const m = raw.match(new RegExp("^"+k+"\\s*:\\s*(.*)$","m"));
        return m ? m[1].trim() : "";
      };
      const uid = get("user_id");
      if(uid && uid !== u.user_id){
        toast("user_id não confere.", "Em produção isso seria bloqueado.");
        return;
      }
      const ptype = get("payload_type");
      const payloadMatch = raw.match(/payload:\s*([\s\S]*?)\n\s*sig:/m);
      const payload = payloadMatch ? payloadMatch[1].trim() : "";

      if(!ptype){
        toast("payload_type ausente.", "Use prefs|perfil|user_space|context_tray|annotations|drafts|patch");
        return;
      }

      if(isReadOnly(u)){
        toast("READ_ONLY: importação bloqueada.", "Ative Gate e tenha licença ACTIVE.");
        return;
      }

      // Aplicações simples
      if(ptype === "prefs"){
        // Espera linhas chave=valor
        payload.split("\n").forEach(line=>{
          const [k,v] = line.split("=").map(s=> (s||"").trim());
          if(k && v) u.preferences[k] = v;
        });
      } else if(ptype === "perfil"){
        payload.split("\n").forEach(line=>{
          const [k,v] = line.split("=").map(s=> (s||"").trim());
          if(k && v) u.perfil_operacional[k] = v;
        });
      } else if(ptype === "context_tray"){
        u.context_tray.content = payload;
        u.context_tray.updated_at = nowISO();
      } else if(ptype === "user_space" || ptype === "annotations"){
        // Demo: se vier com cabeçalho [categoria]
        const parts = payload.split(/\n\[(listas|afazeres|projetos|compras|financeiro|planilhas|anotacoes)\]\n/i);
        for(let i=1;i<parts.length;i+=2){
          const cat = parts[i].toLowerCase();
          const txt = (parts[i+1]||"").trim();
          if(u.user_space[cat] !== undefined) u.user_space[cat] = txt;
        }
      } else {
        // outros: apenas registra
        logEvt("upload_payload_other",{ptype});
      }

      state.users[u.user_id]=u; save(state);
      logEvt("upload_applied",{user_id:u.user_id, payload_type:ptype});
      toast("Upload aplicado (demo).", `payload_type=${ptype}`);
      route("home");
    };

    return;
  }

  if(id==="commands"){
    viewTitle("Comandos ADM");
    v.innerHTML = `
      <div class="muted">
        Lista consolidada (referência canônica). Em produção, isso vira CLI/painel.
      </div>
      <div class="hr"></div>
      <textarea readonly>
[LEV — MODO ADM] (referência)

ESTADO / OPERAÇÃO
- STATUS LEV
- VER PB_VERSION
- VER MODO_ATIVO
- VER ESTADO_GERAL
- ENTRAR MODO ADM
- SAIR MODO ADM
- ENCERRAR SESSAO LEV

GOVERNANÇA / CONTROLE
- VER PB_ACCESS_GATE
- VER RESTRICOES
- VER PROIBICOES
- VER POLITICA_ATUALIZACAO
- VER MODO_REDE
- VER PRIORIDADE_ATUAL

SEGURANÇA (MANUAL / CONTROLADA)
- LEV_SECURITY_APPLY MODE=manual RISK=low
- LEV_SECURITY_VERIFY CHECKS=root,health,api_ping RISK=low
- LEV_TOKEN_ROTATE RISK=medium
- LEV_LOCK_ALL ENABLE=0 RISK=low
- LEV_LOCK_ALL ENABLE=1 RISK=medium

BASELINE / VERSÕES
- LEV_BASELINE_STATUS
- LEV_BASELINE_FREEZE TAG=<nome>
- LEV_BASELINE_COMPARE TAG_A TAG_B

ATUALIZAÇÃO / REINTEGRAÇÃO
- UPDATE
- GERAR BOOT_TRAY
- GERAR UPDATE_TRAY
- ATUALIZAR LEV MAXIMO BUDGET_MIN=<n> RISCO_MAX=<BAIXO|MEDIO|ALTO>
- VER FILA_DE_PATCHES
- VER CHECKPOINT_FINAL

EDIÇÃO DO LEV (NUNCA AUTOMÁTICA)
- EDITAR PB
- SIMULAR ALTERACAO PB
- REESCREVER SECAO PB
- GERAR PATCH
- REVISAR PATCH
- COMPARAR VERSOES PB

PATCH / APLICAÇÃO CONTROLADA
- LEV_APPLY_PATCH ONECLICK=menu_admin RISK=medium
- VER PATCHES_PENDENTES
- VER PATCHES_APLICADOS

CONTEXTO / BANDEJAS
- CONTEXTO ON MODO=MANUAL|AUTO_RESUMO|FULL
- CONTEXTO OFF / VER / LIMPAR / ADICIONAR / RESUMIR
- GERAR BANDEJA_SAIDA
- GERAR ADMIN_EXIT_TRAY

EXPORTAÇÃO / IMPORTAÇÃO
- GERAR LEV_DOWNLOAD PARA SITE
- COLAR LEV_UPLOAD DO SITE
- EXPORTAR LEV PARA SITE COM BANDEJA

SATÉLITE
- ABRIR SATELITE / SAIR SATELITE
- SIMULAR ALTERACAO / TESTAR REGRA / REESCREVER SECAO
- COMPARAR VERSOES / GERAR PATCH / DESCARTAR SIMULACAO

LOGS / AUDITORIA
- VER LOGS / VER LOGS DE UPDATE / ERRO / SEGURANCA / PATCH / EXPORTACAO
      </textarea>
    `;
    return;
  }

  if(id==="logs"){
    viewTitle("Logs");
    const rows = state.logs.slice(0,80).map(e=>`• ${e.at}  ${e.type}  ${JSON.stringify(e.details||{})}`).join("\n");
    v.innerHTML = `
      <div class="muted">Log local (append-only) — demo. Em produção: server logs + auditoria.</div>
      <div class="hr"></div>
      <textarea readonly>${rows || "(sem logs)"}</textarea>
      <div class="btnrow">
        <button class="secondary" id="btnCopyLogs">Copiar</button>
      </div>
    `;
    document.getElementById("btnCopyLogs").onclick = async ()=>{
      await navigator.clipboard.writeText(rows || "");
      toast("Logs copiados.");
    };
    return;
  }

  // fallback
  viewTitle("Tela");
  v.innerHTML = `<div class="muted">Tela não encontrada.</div>`;
}

document.getElementById("btnReset").onclick = ()=>{
  if(!confirm("Apagar todos os dados locais do LEV (MVP)?")) return;
  localStorage.removeItem(STORE_KEY);
  state = load();
  toast("Reset concluído.");
  route("login");
};

document.getElementById("btnExportAll").onclick = async ()=>{
  const u = currentUser();
  const dump = {
    pb_version: PB_VERSION,
    access_gate: state.access_gate,
    session: state.session,
    user: u ? {
      user_id:u.user_id, role:u.role, username:u.username,
      license: u.license,
      preferences:u.preferences,
      perfil_operacional:u.perfil_operacional,
      context_tray:u.context_tray,
      user_space:u.user_space,
      trays:u.trays
    } : null,
    logs: state.logs.slice(0,200)
  };
  await navigator.clipboard.writeText(JSON.stringify(dump, null, 2));
  toast("Exportado para a área de transferência.", "JSON do estado local (MVP).");
};

(function init(){
  setChips();
  renderNav("login");
  route(state.session.logged_in ? "home" : "login");
})();
</script>
</body>
</html>
